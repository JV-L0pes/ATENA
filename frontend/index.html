<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Athena - Dashboard de Detec√ß√£o de EPIs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        athena: {
                            navy: '#0f172a',
                            deepBlue: '#1e293b',
                            royalBlue: '#1e40af',
                            gold: '#d5b481',
                            lightGold: '#e8d5b7',
                            cream: '#fef3c7'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        .glass-effect {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(213, 180, 129, 0.1);
        }
        
        .sidebar-gradient {
            background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
        }
        
        .sidebar-item {
            transition: all 0.2s ease;
        }
        
        .sidebar-item:hover {
            background: rgba(30, 64, 175, 0.1);
            transform: translateX(4px);
        }
        
        .sidebar-item.active {
            background: linear-gradient(135deg, #1e40af, #d5b481);
            box-shadow: 0 4px 8px rgba(30, 64, 175, 0.2);
        }
        
        .floating-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(213, 180, 129, 0.15);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .video-container {
            background: linear-gradient(135deg, #000000, #1a1a1a);
            border: 1px solid rgba(30, 64, 175, 0.2);
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.1);
        }
        
        .athena-gradient-primary { 
            background: linear-gradient(135deg, #1e40af, #1e3a8a); 
        }
        
        .athena-gradient-secondary { 
            background: linear-gradient(135deg, #d5b481, #c4a373);
        }
        
        .loading-spinner {
            background: conic-gradient(from 0deg, transparent, #d5b481, transparent);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .status-indicator {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-athena-navy via-athena-deepBlue to-athena-royalBlue min-h-screen">
    <div x-data="athenaApp()" x-init="init()" class="flex h-screen">
        <!-- Sidebar com navega√ß√£o -->
        <aside class="sidebar-gradient w-80 flex flex-col shadow-lg">
            <!-- Logo/Header da sidebar -->
            <div class="p-4 border-b border-athena-gold/10">
                <div class="flex items-center justify-center">
                    <img src="assets/ATHENA_LOGO.png" alt="ATHENA" class="h-14 w-auto max-w-full">
                </div>
            </div>

            <!-- Navega√ß√£o principal -->
            <nav class="flex-1 p-4 space-y-2">
                <button @click="setActiveView('dashboard')" 
                        :class="activeView === 'dashboard' ? 'sidebar-item active' : 'sidebar-item'"
                        class="w-full text-left px-4 py-3 rounded-lg transition-all duration-200 group">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 athena-gradient-secondary rounded-lg flex items-center justify-center group-hover:scale-105 transition-transform">
                            <i class="fas fa-chart-line text-sm text-athena-cream"></i>
                        </div>
                        <div>
                            <span class="font-medium text-sm text-athena-cream">Dashboard</span>
                            <p class="text-xs text-athena-cream/60">Vis√£o geral</p>
                        </div>
                    </div>
                </button>
                
                <button @click="setActiveView('relatorio')" 
                        :class="activeView === 'relatorio' ? 'sidebar-item active' : 'sidebar-item'"
                        class="w-full text-left px-4 py-3 rounded-lg transition-all duration-200 group">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 athena-gradient-secondary rounded-lg flex items-center justify-center group-hover:scale-105 transition-transform">
                            <i class="fas fa-chart-bar text-sm text-athena-cream"></i>
                        </div>
                        <div>
                            <span class="font-medium text-sm text-athena-cream">Relat√≥rio</span>
                            <p class="text-xs text-athena-cream/60">An√°lises</p>
                        </div>
                    </div>
                </button>
                
                <button @click="setActiveView('historico')" 
                        :class="activeView === 'historico' ? 'sidebar-item active' : 'sidebar-item'"
                        class="w-full text-left px-4 py-3 rounded-lg transition-all duration-200 group">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 athena-gradient-secondary rounded-lg flex items-center justify-center group-hover:scale-105 transition-transform">
                            <i class="fas fa-history text-sm text-athena-cream"></i>
                        </div>
                        <div>
                            <span class="font-medium text-sm text-athena-cream">Hist√≥rico</span>
                            <p class="text-xs text-athena-cream/60">Registros</p>
                        </div>
                    </div>
                        </button>
                        
                <button @click="setActiveView('status')" 
                        :class="activeView === 'status' ? 'sidebar-item active' : 'sidebar-item'"
                        class="w-full text-left px-4 py-3 rounded-lg transition-all duration-200 group">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 athena-gradient-secondary rounded-lg flex items-center justify-center group-hover:scale-105 transition-transform">
                            <i class="fas fa-server text-sm text-athena-cream"></i>
                        </div>
                        <div>
                            <span class="font-medium text-sm text-athena-cream">Status</span>
                            <p class="text-xs text-athena-cream/60">Monitoramento</p>
                        </div>
                    </div>
                        </button>
                        
                <button @click="setActiveView('config')" 
                        :class="activeView === 'config' ? 'sidebar-item active' : 'sidebar-item'"
                        class="w-full text-left px-4 py-3 rounded-lg transition-all duration-200 group">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 athena-gradient-secondary rounded-lg flex items-center justify-center group-hover:scale-105 transition-transform">
                            <i class="fas fa-cog text-sm text-athena-cream"></i>
                        </div>
                        <div>
                            <span class="font-medium text-sm text-athena-cream">Configura√ß√µes</span>
                            <p class="text-xs text-athena-cream/60">Configura√ß√µes do sistema</p>
                        </div>
                    </div>
                </button>
            </nav>

            <!-- Bot√£o Snapshot -->
            <div class="p-4 border-t border-athena-gold/10">
                <button @click="takeSnapshot()" 
                        class="w-16 h-16 mx-auto rounded-full flex items-center justify-center shadow-lg athena-gradient-secondary hover:scale-105 transition-transform">
                    <i class="fas fa-camera text-2xl text-athena-cream"></i>
                </button>
                <p class="text-center text-xs text-athena-cream/60 mt-2 font-medium">Snapshot</p>
            </div>

            <!-- Status da conex√£o -->
            <div class="p-4 border-t border-athena-gold/10">
                    <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 rounded-full status-indicator" 
                         :class="connectionStatus === 'connected' ? 'bg-green-500' : 'bg-red-500'"></div>
                        <div>
                        <span class="text-xs font-medium text-athena-cream" 
                              x-text="connectionStatus === 'connected' ? 'Conectado' : 'Desconectado'"></span>
                            <p class="text-xs text-athena-cream/50">Status</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Conte√∫do principal -->
        <main class="flex-1 flex flex-col bg-gradient-to-br from-athena-navy/50 via-athena-deepBlue/50 to-athena-royalBlue/50">
            <!-- Header -->
            <header class="p-6 border-b border-athena-gold/20">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <h2 class="text-2xl font-bold text-white" x-text="getViewTitle()"></h2>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 rounded-full" 
                                 :class="connectionStatus === 'connected' ? 'bg-green-500' : 'bg-red-500'"></div>
                            <span class="text-sm text-athena-cream" 
                                  x-text="connectionStatus === 'connected' ? 'Sistema Ativo' : 'Sistema Offline'"></span>
                        </div>
                        <div class="text-xs text-athena-cream/60" 
                             x-text="connectionStatus === 'connected' ? `v${systemStatus.api_version || '1.0.0'}` : ''"></div>
                    </div>
                </div>
            </header>

            <!-- Conte√∫do din√¢mico das views -->
            <div class="flex-1 p-6 overflow-auto">
                <!-- Dashboard View -->
                <div x-show="activeView === 'dashboard'" 
                     x-transition:enter="animate-fade-in" 
                     class="space-y-6">
                    <!-- Container do v√≠deo -->
                    <div class="video-container rounded-2xl overflow-hidden">
                        <div class="relative w-full aspect-video">
                            <img id="mjpeg" class="w-full h-full object-contain select-none" 
                                 src="http://localhost:8000/stream.mjpg" 
                                 alt="Stream de v√≠deo"
                                 @load="videoLoaded = true"
                                 @error="videoLoaded = false">
                            <canvas id="overlay" class="absolute inset-0"></canvas>
                            
                            <!-- Overlay de loading -->
                            <div x-show="!videoLoaded" class="absolute inset-0 bg-athena-navy/80 flex items-center justify-center">
                        <div class="text-center">
                                    <div class="loading-spinner w-16 h-16 rounded-full mx-auto mb-4"></div>
                                    <p class="text-athena-cream text-lg font-medium">Carregando stream...</p>
                        </div>
                        </div>
                        </div>
                    </div>
                    
                    <!-- Cards de status -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="floating-card rounded-xl p-6">
                            <div class="flex items-center space-x-4">
                                                        <div class="w-12 h-12 athena-gradient-primary rounded-xl flex items-center justify-center">
                            <i class="fas fa-play text-xl text-athena-cream"></i>
                        </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-athena-cream">Status do Stream</h3>
                                    <p class="text-athena-cream/60" x-text="videoLoaded ? 'Ativo' : 'Carregando...'"></p>
                                    <p class="text-xs text-athena-cream/40" x-text="videoLoaded ? `FPS: ${systemStatus.fps || '30'}` : ''"></p>
                                </div>
                    </div>
                </div>

                        <div class="floating-card rounded-xl p-6">
                            <div class="flex items-center space-x-4">
                                                        <div class="w-12 h-12 athena-gradient-primary rounded-xl flex items-center justify-center">
                            <i class="fas fa-eye text-xl text-athena-cream"></i>
                        </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-athena-cream">Detec√ß√µes</h3>
                                    <p class="text-athena-cream/60" x-text="isDetectionRunning ? 'Ativo' : 'Inativo'"></p>
                                    <p class="text-xs text-athena-cream/40" x-text="`Total: ${stats.total_pessoas || 0}`"></p>
                                </div>
                        </div>
                    </div>
                    
                        <div class="floating-card rounded-xl p-6">
                            <div class="flex items-center space-x-4">
                                                        <div class="w-12 h-12 athena-gradient-primary rounded-xl flex items-center justify-center">
                            <i class="fas fa-signal text-xl text-athena-cream"></i>
                        </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-athena-cream">Conex√£o</h3>
                                    <p class="text-athena-cream/60" x-text="connectionStatus === 'connected' ? 'Conectado' : 'Desconectado'"></p>
                                    <p class="text-xs text-athena-cream/40" x-text="connectionStatus === 'connected' ? `API: ${systemStatus.api_version || '1.0.0'}` : 'Verificando...'"></p>
                                </div>
                            </div>
                    </div>
                </div>
            </div>

                <!-- Relat√≥rio View -->
                <div x-show="activeView === 'relatorio'" 
                     x-transition:enter="animate-fade-in" 
                     class="space-y-6">
                    <div class="floating-card rounded-xl p-6">
                        <h3 class="text-2xl font-bold text-athena-cream mb-6">Relat√≥rio de Detec√ß√µes</h3>
                        
                        <!-- Gr√°fico -->
                        <div class="floating-card rounded-xl p-6">
                            <h4 class="text-lg font-semibold text-athena-cream mb-4">Estat√≠sticas de Detec√ß√£o</h4>
                            <div class="h-80 w-full">
                                <canvas id="reportChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- M√©tricas resumidas -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mt-6">
                            <div class="floating-card rounded-xl p-6 text-center">
                                <div class="w-16 h-16 athena-gradient-primary rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-hard-hat text-2xl text-athena-cream"></i>
                                </div>
                                <h5 class="text-lg font-semibold text-athena-cream mb-2">Com Capacete</h5>
                                <p class="text-3xl font-bold text-green-400" x-text="stats.com_capacete || 0"></p>
                            </div>
                            
                            <div class="floating-card rounded-xl p-6 text-center">
                                <div class="w-16 h-16 athena-gradient-primary rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-user text-2xl text-athena-cream"></i>
                                </div>
                                <h5 class="text-lg font-semibold text-athena-cream mb-2">Sem Capacete</h5>
                                <p class="text-3xl font-bold text-red-400" x-text="stats.sem_capacete || 0"></p>
                            </div>
                            
                            <div class="floating-card rounded-xl p-6 text-center">
                                <div class="w-16 h-16 athena-gradient-primary rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-tshirt text-2xl text-athena-cream"></i>
                                </div>
                                <h5 class="text-lg font-semibold text-athena-cream mb-2">Com Colete</h5>
                                <p class="text-3xl font-bold text-green-400" x-text="stats.com_colete || 0"></p>
                            </div>
                            
                            <div class="floating-card rounded-xl p-6 text-center">
                                <div class="w-16 h-16 athena-gradient-primary rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-user-times text-2xl text-athena-cream"></i>
                                </div>
                                <h5 class="text-lg font-semibold text-athena-cream mb-2">Sem Colete</h5>
                                <p class="text-3xl font-bold text-red-400" x-text="stats.sem_colete || 0"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hist√≥rico View -->
                <div x-show="activeView === 'historico'" 
                     x-transition:enter="animate-fade-in" 
                     class="space-y-6">
                    <div class="floating-card rounded-xl p-6">
                        <h3 class="text-2xl font-bold text-athena-cream mb-6">Hist√≥rico de Detec√ß√µes</h3>
                        
                        <!-- Tabela de hist√≥rico -->
                        <div class="floating-card rounded-xl overflow-hidden">
                            <table class="w-full">
                                <thead class="bg-athena-royalBlue/80">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-athena-cream font-semibold">Data/Hora</th>
                                        <th class="px-6 py-4 text-left text-athena-cream font-semibold">EPI Status</th>
                                        <th class="px-6 py-4 text-left text-athena-cream font-semibold">Confian√ßa</th>
                                        <th class="px-6 py-4 text-left text-athena-cream font-semibold">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-athena-gold/20">
                                    <template x-for="item in history" :key="item.id">
                                        <tr class="hover:bg-athena-royalBlue/20 transition-colors">
                                            <td class="px-6 py-4 text-athena-cream/80" x-text="formatDateTime(item.timestamp)"></td>
                                            <td class="px-6 py-4">
                                                <span class="px-3 py-1 rounded-full text-xs font-medium bg-green-500 text-white">
                                                    EPI Completo
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-athena-cream/80">85%</td>
                                            <td class="px-6 py-4">
                                                <button class="athena-gradient-primary px-3 py-1 rounded-lg text-athena-cream text-sm hover:scale-105 transition-transform">
                                                    <i class="fas fa-eye mr-1"></i>Ver
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Status View -->
                <div x-show="activeView === 'status'" 
                     x-transition:enter="animate-fade-in" 
                     class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Status do Sistema -->
                        <div class="floating-card rounded-xl p-6">
                            <div class="flex items-center space-x-4 mb-4">
                                <div class="w-12 h-12 athena-gradient-primary rounded-xl flex items-center justify-center">
                                    <i class="fas fa-server text-xl text-athena-cream"></i>
                                </div>
                                <h3 class="text-xl font-semibold text-athena-cream">Status do Sistema</h3>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-athena-cream/80">Status:</span>
                                    <span class="px-3 py-1 rounded-full text-sm font-medium bg-green-500 text-white">
                                        Online
                                    </span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-athena-cream/80">Uptime:</span>
                                    <span class="text-athena-cream font-medium" x-text="formatDuration(systemStatus.uptime_s || 0)"></span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-athena-cream/80">Vers√£o:</span>
                                    <span class="text-athena-cream font-medium" x-text="systemStatus.version || '1.0.0'"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Conex√µes -->
                        <div class="floating-card rounded-xl p-6">
                            <div class="flex items-center space-x-4 mb-4">
                                <div class="w-12 h-12 athena-gradient-primary rounded-xl flex items-center justify-center">
                                    <i class="fas fa-network-wired text-xl text-athena-cream"></i>
                                </div>
                                <h3 class="text-xl font-semibold text-athena-cream">Conex√µes</h3>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-athena-cream/80">API:</span>
                                    <span class="px-3 py-1 rounded-full text-sm font-medium" 
                                          :class="connectionStatus === 'connected' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'"
                                          x-text="connectionStatus === 'connected' ? 'Ativa' : 'Inativa'"></span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-athena-cream/80">Stream:</span>
                                    <span class="px-3 py-1 rounded-full text-sm font-medium" 
                                          :class="videoLoaded ? 'bg-green-500 text-white' : 'bg-red-500 text-white'"
                                          x-text="videoLoaded ? 'Ativo' : 'Inativo'"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Config View -->
                <div x-show="activeView === 'config'" 
                     x-transition:enter="animate-fade-in" 
                     class="space-y-6">
                    <div class="floating-card rounded-xl p-6">
                        <h3 class="text-2xl font-bold text-athena-cream mb-6">Configura√ß√µes do Sistema</h3>
                        
                        <form @submit.prevent="saveConfig()" class="space-y-6">
                            <!-- Configura√ß√µes do Modelo de IA -->
                            <div class="space-y-4">
                                <h4 class="text-lg font-semibold text-athena-cream border-b border-athena-gold/20 pb-2">Par√¢metros do Modelo de IA</h4>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-athena-cream/80 mb-2">Threshold de Confian√ßa</label>
                                        <div class="space-y-2">
                                            <input type="range" min="0.1" max="1.0" step="0.05" 
                                                   x-model="config.conf_thresh" 
                                                   class="w-full h-2 bg-athena-deepBlue rounded-lg appearance-none cursor-pointer">
                                            <div class="flex justify-between text-sm text-athena-cream/60">
                                                <span>0.1</span>
                                                <span class="text-athena-cream font-medium" x-text="config.conf_thresh"></span>
                                                <span>1.0</span>
                                            </div>
                                        </div>
                                    </div>
                                            
                                    <div>
                                        <label class="block text-sm font-medium text-athena-cream/80 mb-2">IOU Threshold</label>
                                        <div class="space-y-2">
                                            <input type="range" min="0.1" max="1.0" step="0.05" 
                                                   x-model="config.iou" 
                                                   class="w-full h-2 bg-athena-deepBlue rounded-lg appearance-none cursor-pointer">
                                            <div class="flex justify-between text-sm text-athena-cream/60">
                                                <span>0.1</span>
                                                <span class="text-athena-cream font-medium" x-text="config.iou"></span>
                                                <span>1.0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                    </div>
                    
                            <!-- Bot√µes de a√ß√£o -->
                            <div class="flex items-center justify-end space-x-4 pt-6 border-t border-athena-gold/20">
                                <button type="button" @click="loadConfig()" 
                                        class="px-6 py-3 athena-gradient-secondary rounded-lg text-athena-cream font-medium hover:scale-105 transition-transform">
                                    <i class="fas fa-undo mr-2"></i>Restaurar Padr√£o
                        </button>
                                <button type="submit" 
                                        class="px-6 py-3 athena-gradient-primary rounded-lg text-athena-cream font-medium hover:scale-105 transition-transform">
                                    <i class="fas fa-save mr-2"></i>Salvar Configura√ß√µes
                        </button>
                    </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <script>
        // Configura√ß√µes da aplica√ß√£o
        const CONFIG = {
            API: {
                BASE_URL: 'http://localhost:8000',
                ENDPOINTS: {
                    HEALTH: '/health',
                    STATUS: '/status',
                    DETECTIONS: '/events/detections',
                    STREAM: '/stream.mjpg',
                    CONFIG: '/config',
                    STATS: '/stats',
                    HISTORY: '/history'
                }
            }
        };

        // Utilit√°rios
        function formatDateTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(typeof timestamp === 'string' ? timestamp : timestamp * 1000);
            return date.toLocaleString('pt-BR');
        }

        function formatDuration(seconds) {
            if (!seconds || seconds < 0) return '0s';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        // Fun√ß√£o principal do Alpine.js
        function athenaApp() {
            return {
                // Estado da aplica√ß√£o
                activeView: 'dashboard',
                connectionStatus: 'disconnected',
                videoLoaded: false,
                isDetectionRunning: false,

                // Dados
                stats: {
                    com_capacete: 0,
                    sem_capacete: 0,
                    com_colete: 0,
                    sem_colete: 0,
                    total_pessoas: 0
                },

                history: [],
                
                systemStatus: {
                    fps: 0,
                    uptime_s: 0,
                    version: '1.0.0',
                    api_version: '1.0.0',
                    status: 'offline'
                },

                config: {
                    conf_thresh: 0.35,
                    iou: 0.45,
                    max_detections: 50,
                    batch_size: 1,
                    enable_tracking: true
                },

                // Sistema de detec√ß√µes
                eventSource: null,
                reportChart: null,

                // Inicializa√ß√£o
                init() {
                    console.log('üöÄ Inicializando Athena Dashboard');
                    
                    // Carregar dados iniciais
                    this.loadSystemStatus();
                    this.loadConfig();
                    this.loadHistory();
                    
                    // Conectar com backend
                    this.connectToBackend();
                    
                    // Inicializar gr√°fico ap√≥s um pequeno delay
                    setTimeout(() => {
                        this.initChart();
                    }, 100);
                    
                    console.log('‚úÖ Athena Dashboard inicializado');
                },

                // Navega√ß√£o
                setActiveView(viewName) {
                    console.log('üìç Navegando para:', viewName);
                    this.activeView = viewName;
                    
                    // Carregar dados espec√≠ficos da view
                    switch(viewName) {
                        case 'relatorio':
                            this.loadReportData();
                            break;
                        case 'historico':
                            this.loadHistory();
                            break;
                        case 'status':
                            this.loadSystemStatus();
                            break;
                        case 'config':
                            this.loadConfig();
                            break;
                    }
                },

                // T√≠tulos das views
                getViewTitle() {
                    const titles = {
                        dashboard: 'Dashboard',
                        relatorio: 'Relat√≥rio',
                        historico: 'Hist√≥rico',
                        status: 'Status do Sistema',
                        config: 'Configura√ß√µes'
                    };
                    return titles[this.activeView] || 'Dashboard';
                },

                // Conex√£o com backend
                connectToBackend() {
                    this.connectSSE();
                },

                // Conex√£o SSE
                connectSSE() {
                    try {
                        this.eventSource = new EventSource(CONFIG.API.BASE_URL + CONFIG.API.ENDPOINTS.DETECTIONS);
                        
                        this.eventSource.onopen = () => {
                            console.log('‚úÖ SSE conectado');
                            this.connectionStatus = 'connected';
                        };
                        
                        this.eventSource.onmessage = (event) => {
                            try {
                                const data = JSON.parse(event.data);
                                this.processDetectionData(data);
                            } catch (error) {
                                console.error('‚ùå Erro ao processar dados SSE:', error);
                            }
                        };
                        
                        this.eventSource.onerror = (error) => {
                            console.error('‚ùå Erro SSE:', error);
                            this.connectionStatus = 'disconnected';
                            this.eventSource.close();
                            
                            // Tentar reconectar ap√≥s 5 segundos
                            setTimeout(() => {
                                this.connectSSE();
                            }, 5000);
                        };
                        
                    } catch (error) {
                        console.error('‚ùå Erro ao conectar SSE:', error);
                        this.connectionStatus = 'disconnected';
                    }
                },

                // Processar dados de detec√ß√£o
                processDetectionData(data) {
                    if (!data || !data.frame_id) return;
                    
                    // Atualizar estat√≠sticas se dispon√≠vel
                    if (data.epi_summary) {
                        this.stats = { ...data.epi_summary };
                        this.isDetectionRunning = true;
                    }
                    
                    // Atualizar gr√°fico se estiver na view de relat√≥rio
                    if (this.activeView === 'relatorio' && this.reportChart) {
                        this.updateChart();
                    }
                },

                // Carregar status do sistema
                async loadSystemStatus() {
                    try {
                        const response = await fetch(CONFIG.API.BASE_URL + CONFIG.API.ENDPOINTS.STATUS);
                        if (response.ok) {
                            const status = await response.json();
                            this.systemStatus = { ...this.systemStatus, ...status };
                            this.connectionStatus = status.status === 'online' ? 'connected' : 'disconnected';
                        }
                    } catch (error) {
                        console.error('‚ùå Erro ao carregar status:', error);
                        this.connectionStatus = 'disconnected';
                    }
                },

                // Carregar configura√ß√µes
                async loadConfig() {
                    try {
                        const response = await fetch(CONFIG.API.BASE_URL + CONFIG.API.ENDPOINTS.CONFIG);
                        if (response.ok) {
                            const config = await response.json();
                            this.config = { ...this.config, ...config };
                        }
                    } catch (error) {
                        console.error('‚ùå Erro ao carregar configura√ß√µes:', error);
                    }
                },

                // Salvar configura√ß√µes
                async saveConfig() {
                    try {
                        const response = await fetch(CONFIG.API.BASE_URL + CONFIG.API.ENDPOINTS.CONFIG, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.config)
                        });
                        
                        if (response.ok) {
                            console.log('‚úÖ Configura√ß√µes salvas com sucesso');
                            alert('Configura√ß√µes salvas com sucesso!');
                        } else {
                            throw new Error('Falha ao salvar configura√ß√µes');
                        }
                    } catch (error) {
                        console.error('‚ùå Erro ao salvar configura√ß√µes:', error);
                        alert('Erro ao salvar configura√ß√µes!');
                    }
                },

                // Carregar hist√≥rico
                async loadHistory() {
                    try {
                        const response = await fetch(CONFIG.API.BASE_URL + CONFIG.API.ENDPOINTS.HISTORY + '?limit=50');
                        if (response.ok) {
                            const data = await response.json();
                            this.history = data.data || [];
                        }
                    } catch (error) {
                        console.error('‚ùå Erro ao carregar hist√≥rico:', error);
                        this.history = [];
                    }
                },

                // Carregar dados para relat√≥rios
                loadReportData() {
                    // Simular dados do relat√≥rio
                    setTimeout(() => {
                        if (this.reportChart) {
                            this.updateChart();
                        }
                    }, 100);
                },

                // Inicializar gr√°fico
                initChart() {
                    const ctx = document.getElementById('reportChart');
                    if (!ctx) {
                        console.log('‚ö†Ô∏è Canvas do gr√°fico n√£o encontrado');
                        return;
                    }
                    
                    this.reportChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Com Capacete', 'Sem Capacete', 'Com Colete', 'Sem Colete'],
                            datasets: [{
                                label: 'Detec√ß√µes',
                                data: [
                                    this.stats.com_capacete || 0,
                                    this.stats.sem_capacete || 0,
                                    this.stats.com_colete || 0,
                                    this.stats.sem_colete || 0
                                ],
                                backgroundColor: [
                                    '#10b981', // Verde para com EPI
                                    '#ef4444', // Vermelho para sem EPI
                                    '#10b981', // Verde para com EPI
                                    '#ef4444'  // Vermelho para sem EPI
                                ],
                                borderColor: [
                                    '#059669',
                                    '#dc2626',
                                    '#059669',
                                    '#dc2626'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: '#374151'
                                    },
                                    ticks: {
                                        color: '#9ca3af'
                                    }
                                },
                                x: {
                                    grid: {
                                        color: '#374151'
                                    },
                                    ticks: {
                                        color: '#9ca3af'
                                    }
                                }
                            }
                        }
                    });
                    
                    console.log('üìä Gr√°fico inicializado');
                },

                // Atualizar gr√°fico
                updateChart() {
                    if (!this.reportChart) return;
                    
                    const chartData = [
                        this.stats.com_capacete || 0,
                        this.stats.sem_capacete || 0,
                        this.stats.com_colete || 0,
                        this.stats.sem_colete || 0
                    ];
                    
                    this.reportChart.data.datasets[0].data = chartData;
                    this.reportChart.update();
                },

                // Capturar snapshot
                async takeSnapshot() {
                    try {
                        const response = await fetch(CONFIG.API.BASE_URL + '/snapshot', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const result = await response.json();
                        
                        if (result.saved) {
                            console.log('üì∏ Snapshot capturado com sucesso');
                            alert('Snapshot capturado com sucesso!');
                            
                            if (result.url) {
                                setTimeout(() => {
                                    window.open(result.url, '_blank');
                                }, 500);
                            }
                        } else {
                            console.error('‚ùå Erro ao capturar snapshot');
                            alert('Erro ao capturar snapshot!');
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Erro ao capturar snapshot:', error);
                        alert('Erro de comunica√ß√£o com o servidor!');
                    }
                },

                // Utilit√°rios
                formatDateTime,
                formatDuration
            };
        }
    </script>